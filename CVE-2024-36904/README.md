# CVE-2024-36904 - Use-after-free vulnerability in the TCP subsystem of the Linux kernel due to `inet_twsk_hashdance()` function inserting the time-wait socket into established hash table before setting its reference counter.

This folder contains the codes and files related to the research we performed that led to CVE-2024-36904. We wrote a blog post about it on our website [1]. In this repository you can find the syzkaller original reproducer that accidentally triggered the vulnerability, its minimized version that helps to understand the code that triggers the vulnerability and the trigger we wrote from scratch. 

You can also find the kernel source code we modified to obtain a KASAN splat confirming a real use-after-free is possible, as well as the original kernel source code and a patch that can be applied to it to obtain the kernel source code we modified for this research. The kernels present in `kernels/` do not contain a configuration file (`.config`) that is used to build them. The original kernel configuration file is 
present in `config/`. It can be used to build the original and the research kernel. As it is the original kernel configuration file, it does not have KASAN enabled. When building the original kernel, the error below is shown. It happens because the original configuration file defines `CONFIG_SYSTEM_TRUSTED_KEYS` to `"certs/rhel.pem"` and as this file does not exist, the building fails. We provide a script named 
`build.sh` in `build/` that enables KASAN and builds the kernel successfully by setting `CONFIG_SYSTEM_TRUSTED_KEYS` to its default value `certs/signing_key.pem`. When this default value is used, the kernel automatically creates the needed keypair. The research kernel Makefile is also changed to append `-RESEARCH-KASAN` to the kernel name to make it easy to be identified during boot.

```
  AS [M]  arch/x86/kvm/svm/vmenter.o
  LD [M]  arch/x86/kvm/kvm-intel.o
  LD [M]  arch/x86/kvm/kvm-amd.o
  AR      arch/x86/built-in.a
make[1]: *** No rule to make target 'certs/rhel.pem', needed by 'certs/x509_certificate_list'.  Stop.
make[1]: *** Waiting for unfinished jobs....
  CC      certs/system_keyring.o
  CC      kernel/module_signature.o
  CC      kernel/kallsyms.o
make: *** [Makefile:1944: certs] Error 2
make: *** Waiting for unfinished jobs....
  CC      kernel/acct.o
  CC      kernel/crash_core.o
```

All the experiments were performed on the Alma Linux 9 distribution with the kernel version: `5.14.0-362.24.2.el9_3.x86_64`. All the results obtained from this research should also work on other kernels considering the vulnerability is still present. The machine used is a Samsung laptop with processor Intel(R) Core(TM) i7-8565U CPU @ 1.80GHz running Fedora 39 and Fedora 41 with Power Mode set to Performance. The Alma
Linux 9 distribution was used as a virtual machine on VMware Workstation version 17.6.2 or older. The virtual machine is configured with 4 CPUs and 2 GB of RAM memory.

This repository is organized in the following way:

build/ - Script to build the kernels.\
codes/ - All proofs of concept.\
config/ - The original kernel configuration.\
kernels/ - The original and the modified research kernel.\
logs/ - The splats obtained during this research.\
packages/ - The original kernel RPMs.\
patch/ - The modified research kernel patch.

In the original kernel version, the syzkaller reproducer takes many hours to trigger the reference counter warnings. In our experiments, it takes around 48 hours. We run 6 parallels instances of the code, each one in a terminal, connected via ssh. When running only one instance, it doesn't trigger it or it takes much longer.

In the modified research kernel with KASAN enabled, the RCU flag of the TCP cache removed and the `mdelay()` calls, the KASAN splat is triggered in less than 30 minutes when running our trigger or the syzkaller minimized version. In our experiments, we didn't observe any side effect of removing the RCU flag of the TCP cache, but it might happen.

To get the modified research kernel from the original kernel, the patch can be applied the following way:

```
$ cd kernels/linux-5.14.0-362.24.1.el9_3/
$ patch -p1 < ../../patch/mdelay_remove_rcu_flag.patch
```

And then the kernel can be built using the script. If the build succeeds, the kernel can be installed.

```
$ ../../build/build.sh
$ make -j `nproc` modules_install install
```

The following packages need to be installed in a new instance of Alma Linux 9 to config and build the kernel successfully:

```
ncurses-devel
flex
bison
elfutils-libelf-devel
openssl-devel
bc
perl
dwarves
```

In order to trigger the vulnerability and the KASAN splat in the research kernel with our trigger, run it as shown below. After some minutes, the reference counter warnings and the KASAN splat show up on the kernel ring buffer.

```
$ while true; do ./CVE-2024-36904-trigger; done
```

In the Red Hat Enterprise Linux 9 ecosystem, the vulnerability was fixed on kernel 5.14-427.26.1 on July 16, 2024.

# References

Accidentally uncovering a seven years old vulnerability in the Linux kernel\
[1] - https://allelesecurity.com/accidentally-uncovering-a-seven-years-old-vulnerability-in-the-linux-kernel/

tcp: Use refcount_inc_not_zero() in tcp_twsk_unique().\
[2] - https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=f2db7230f73a80dbb179deab78f88a7947f0ab7e

CVE-2024-36904\
[3] - https://access.redhat.com/security/cve/CVE-2024-36904

CVE-2024-36904\
[4] - https://www.suse.com/security/cve/CVE-2024-36904.html

CVE-2024-36904\
[5] - https://explore.alas.aws.amazon.com/CVE-2024-36904.html

CVE-2024-36904\
[6] - https://linux.oracle.com/cve/CVE-2024-36904.html

CVE-2024-36904\
[7] - https://security-tracker.debian.org/tracker/CVE-2024-36904
