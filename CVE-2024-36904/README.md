# CVE-2024-36904 - Use-after-free vulnerability in the TCP subsystem of the Linux kernel due to `inet_twsk_hashdance()` function inserting the time-wait socket into established hash table before setting its reference counter.

This folder contains the codes and files related to the research we performed that led to CVE-2024-36904. We wrote a blog post about it on our website [1]. In this repository you can find the syzkaller original reproducer that accidentally triggered the vulnerability, its minimized version that helps to understand the code that triggers the vulnerability and the trigger we wrote from scratch. You can also find the 
kernel source code we modified to obtain a KASAN splat confirming a real use-after-free is possible, as well as the original source code and a patch that can be applied to it to obtain the kernel source code we modified for this research. The modified research kernel present in `kernel/` already contains a configuration file (.config) that is used to build it. The kernel Makefile is also changed to append 
`-RESEARCH-KASAN` to the kernel name to make it easy to be identified during boot.

All the experiments were performed on the Alma Linux 9 distribution with the kernel version: `5.14.0-362.24.2.el9_3.x86_64`. All the results obtained from this research should also work on other kernels considering the vulnerability is still not fixed. The machine used is a Samsung laptop with processor Intel(R) Core(TM) i7-8565U CPU @ 1.80GHz running Fedora 39 and Fedora 41 with Power Mode set to Performance. The Alma 
Linux 9 distribution was used as a virtual machine on VMware Workstation version 17.6.2 or older. The virtual machine is configured with 4 CPUs and 2 GB of RAM memory.

This repository is organized in the following way:

codes/ - All proofs of concept.
kernel/ - The original, the modified kernel and a patch file.
logs/ - The splats obtained during this research.

In the original kernel version, the syzkaller reproducer takes many hours to trigger the reference counter warnings. In our experiments, it takes aroubd 48 hours. We run 6 parallels instances of the code, each one in a terminal. When running only one instance, it doesn't trigger it or it takes much longer.
In the modified research kernel that contains KASAN enabled and the RCU flag of the TCP cache removed, the KASAN splat is triggered in less than 10 minutes when running any of the proofs of concept. In our experiments, we didn't observe any side effect of removing the RCU flag of the TCP cache, but it might happen.

The patch can be applied the following way:

```
$ cd kernels/linux-5.14.0-362.24.1.el9_3/
$ patch -n1 < ../mdelay_remove_rcu_flag.patch
```

And then the kernel can be built normally:

```
make -j `nproc`
make -j `nproc` modules_install install
```

The following packages need to be installed in a new instance of Alma Linux 9 to build the kernel successfully:

```
flex
bison
elfutils-libelf-devel
openssl-devel
bc
perl
dwarves
```

In order to trigger the vulnerability and the KASAN splat in the research kernel with our trigger, run it as shown below. After some minutes, the reference counter warnings and the KASAN splat show up on the kernel ring buffer.

```
while true; do ./CVE-2024-36904-trigger; done
```

In the Red Hat Enterprise Linux 9 ecosystem, the vulnerability was fixed on kernel 5.14-427.26.1 on July 16, 2024. 

# References

Accidentally uncovering a seven years old vulnerability in the Linux kernel
[1] - https://allelesecurity.com/accidentally-uncovering-a-seven-years-old-vulnerability-in-the-linux-kernel/

tcp: Use refcount_inc_not_zero() in tcp_twsk_unique().
[2] - https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=f2db7230f73a80dbb179deab78f88a7947f0ab7e

CVE-2024-36904
[3] - https://access.redhat.com/security/cve/CVE-2024-36904

CVE-2024-36904
[4] - https://www.suse.com/security/cve/CVE-2024-36904.html

CVE-2024-36904
[5] - https://explore.alas.aws.amazon.com/CVE-2024-36904.html

CVE-2024-36904
[6] - https://linux.oracle.com/cve/CVE-2024-36904.html

CVE-2024-36904
[7] - https://security-tracker.debian.org/tracker/CVE-2024-36904
